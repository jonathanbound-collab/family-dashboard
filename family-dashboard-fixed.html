<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FamilyHub Dashboard</title>

  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
    .hide-scroll::-webkit-scrollbar { display: none; }
    .hide-scroll { scrollbar-width: none; }
    iframe { border-radius: 1.5rem; }
  </style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useCallback, useMemo } = React;

/* ================= CONFIG ================= */

const CLIENT_ID = 'YOUR_CLIENT_ID.apps.googleusercontent.com';
const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly';

const MAPS_API_KEY = 'YOUR_MAPS_KEY';
const HOME_ADDRESS = 'Wood Lane, Southmoor, Oxfordshire';
const SCHOOL_ADDRESS = 'Pinewood School, Bourton, Wiltshire';

const FAMILY_MEMBERS = ['Jonathan', 'Alex', 'Rufus', 'Madeline', 'Theo'];

const MEMBER_CONFIG = {
  Jonathan: { tag: 'bg-blue-600', variations: ['jonathan','jon'], color: 'bg-blue-50 text-blue-800 border-blue-200' },
  Alex: { tag: 'bg-rose-600', variations: ['alex','alexandra'], color: 'bg-rose-50 text-rose-800 border-rose-200' },
  Rufus: { tag: 'bg-orange-600', variations: ['rufus'], color: 'bg-orange-50 text-orange-800 border-orange-200' },
  Madeline: { tag: 'bg-fuchsia-600', variations: ['madeline','maddie','maddy'], color: 'bg-fuchsia-50 text-fuchsia-800 border-fuchsia-200' },
  Theo: { tag: 'bg-indigo-600', variations: ['theo','theodore'], color: 'bg-indigo-50 text-indigo-800 border-indigo-200' },
  Family: { tag: 'bg-emerald-600', variations: [], color: 'bg-emerald-50 text-emerald-800 border-emerald-200' }
};

const AVATAR_COLORS = [
  'bg-indigo-400',
  'bg-indigo-500',
  'bg-indigo-600',
  'bg-indigo-700',
  'bg-indigo-800'
];

/* ================= ICONS ================= */

const Icons = {
  Calendar: () => (
    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
      <rect x="3" y="4" width="18" height="18" rx="2"/>
      <line x1="16" y1="2" x2="16" y2="6"/>
      <line x1="8" y1="2" x2="8" y2="6"/>
      <line x1="3" y1="10" x2="21" y2="10"/>
    </svg>
  )
};

/* ================= APP ================= */

function App() {
  const [user, setUser] = useState(null);
  const [events, setEvents] = useState([]);
  const [tokenClient, setTokenClient] = useState(null);
  const [loading, setLoading] = useState(false);
  const [now, setNow] = useState(new Date());

  useEffect(() => {
    const t = setInterval(() => setNow(new Date()), 1000);
    return () => clearInterval(t);
  }, []);

  /* -------- Calendar helpers -------- */

  const categorizeEvent = (event) => {
    const text = `${event.summary || ''} ${event.description || ''}`.toLowerCase();
    const words = text.split(/\W+/);

    const matches = FAMILY_MEMBERS.filter(m =>
      MEMBER_CONFIG[m].variations.some(v => words.includes(v))
    );

    return matches.length ? matches : ['Family'];
  };

  const fetchEvents = useCallback(async (accessToken) => {
    if (!window.gapi?.client?.calendar) return;

    setLoading(true);
    window.gapi.client.setToken({ access_token: accessToken });

    const start = new Date();
    start.setHours(0,0,0,0);
    const end = new Date(start);
    end.setDate(end.getDate() + 31);

    const calendars = [
      'primary',
      'jonathan.bound@gmail.com',
      'family07456545553640322749@group.calendar.google.com'
    ];

    let collected = [];

    for (const id of calendars) {
      try {
        const r = await window.gapi.client.calendar.events.list({
          calendarId: id,
          timeMin: start.toISOString(),
          timeMax: end.toISOString(),
          singleEvents: true,
          orderBy: 'startTime'
        });

        collected.push(
          ...(r.result.items || []).map(e => ({
            ...e,
            start_date: new Date(e.start.dateTime || e.start.date),
            assignedTo: categorizeEvent(e),
            calendarName: id.includes('family') ? 'Family' : 'Personal'
          }))
        );
      } catch {}
    }

    collected.sort((a,b) => a.start_date - b.start_date);
    setEvents(collected);
    setLoading(false);
  }, []);

  /* -------- Google API init -------- */

  useEffect(() => {
    const gapiScript = document.createElement('script');
    gapiScript.src = 'https://apis.google.com/js/api.js';
    gapiScript.onload = () => {
      window.gapi.load('client', async () => {
        await window.gapi.client.init({ discoveryDocs: [DISCOVERY_DOC] });
      });
    };
    document.body.appendChild(gapiScript);

    const gis = document.createElement('script');
    gis.src = 'https://accounts.google.com/gsi/client';
    gis.onload = () => {
      const client = window.google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (token) => {
          setUser(token);
          fetchEvents(token.access_token);
        }
      });
      setTokenClient(client);
    };
    document.body.appendChild(gis);
  }, [fetchEvents]);

  /* -------- Columns -------- */

  const columns = useMemo(() => {
    const today = new Date(); today.setHours(0,0,0,0);
    const week = new Date(today); week.setDate(today.getDate() + 7);

    return {
      Today: events.filter(e => e.start_date.toDateString() === today.toDateString()),
      'This Week': events.filter(e => e.start_date > today && e.start_date < week),
      'This Month': events.filter(e => e.start_date.getMonth() === today.getMonth())
    };
  }, [events]);

  /* ================= RENDER ================= */

  return (
    <div className="h-screen flex flex-col bg-slate-50">
      <header className="bg-white p-8 border-b flex justify-between items-center">
        <div>
          <h1 className="text-4xl font-black">FamilyHub</h1>
          <p className="text-xs uppercase tracking-widest text-slate-400">
            {now.toLocaleDateString(undefined,{weekday:'long',month:'long',day:'numeric'})}
          </p>
        </div>
        <div className="flex -space-x-3">
          {FAMILY_MEMBERS.map((m,i)=>(
            <div key={m}
              className={`w-12 h-12 rounded-full border-4 border-white text-white font-black flex items-center justify-center shadow ${AVATAR_COLORS[i]}`}>
              {m[0]}
            </div>
          ))}
        </div>
      </header>

      {!user ? (
        <div className="flex flex-col items-center justify-center flex-grow">
          <Icons.Calendar />
          <h2 className="text-2xl font-black mt-6">Connect Google Calendar</h2>
          <button
            onClick={() => tokenClient?.requestAccessToken()}
            className="mt-8 bg-indigo-600 text-white px-10 py-4 rounded-2xl font-bold">
            Authorize
          </button>
        </div>
      ) : (
        <main className="grid grid-cols-1 md:grid-cols-3 gap-6 p-10 flex-grow overflow-hidden">
          {Object.entries(columns).map(([k,v])=>(
            <div key={k} className="bg-white rounded-3xl border overflow-hidden">
              <div className="p-6 font-black uppercase text-sm tracking-widest bg-slate-50 flex justify-between">
                {k}
                <span>{v.length}</span>
              </div>
              <div className="p-6 space-y-4 overflow-y-auto hide-scroll">
                {v.map(e=>(
                  <div key={e.id} className={`p-4 rounded-2xl border-l-8 ${MEMBER_CONFIG[e.assignedTo[0]].color}`}>
                    <p className="font-bold">{e.summary}</p>
                    <div className="flex gap-2 mt-2">
                      {e.assignedTo.map(p=>(
                        <span key={p} className={`text-xs px-2 py-1 rounded-full text-white ${MEMBER_CONFIG[p].tag}`}>
                          {p}
                        </span>
                      ))}
                    </div>
                  </div>
                ))}
                {v.length === 0 && <p className="text-center text-slate-300">No events</p>}
              </div>
            </div>
          ))}
        </main>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>

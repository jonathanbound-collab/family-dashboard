import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { 
  Calendar as CalendarIcon, Clock, Plus, Users, LayoutDashboard,
  Bell, CheckCircle2, MoreVertical, LogIn, LogOut, RefreshCw,
  CloudSun, Car, AlertTriangle, ShieldCheck, Terminal, Copy, Check
} from 'lucide-react';

// --- Configuration ---
const CLIENT_ID = '123608984638-af4v7ira3qae7ftbbi10dhvd7hbgotsb.apps.googleusercontent.com';
const API_KEY = ''; // Optional: Add your API Key here if discovery docs fail to load
const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest";
const SCOPES = "https://www.googleapis.com/auth/calendar.readonly";

const CALENDAR_IDS = [
  'jonathan.bound@gmail.com',
  'family07456545553640322749@group.calendar.google.com'
];

const FAMILY_MEMBERS = ['Jonathan', 'Alex', 'Rufus', 'Madeline', 'Theo'];
const NAME_VARIATIONS = {
  'Jonathan': ['jonathan', 'jon'],
  'Alex': ['alex', 'alexandra'],
  'Rufus': ['rufus'],
  'Madeline': ['madeline', 'maddie', 'maddy'],
  'Theo': ['theo', 'theodore']
};

const App = () => {
  const [currentDate, setCurrentDate] = useState(new Date());
  const [view, setView] = useState('today');
  const [allEvents, setAllEvents] = useState([]);
  const [weather, setWeather] = useState(null);
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [tokenClient, setTokenClient] = useState(null);
  const [isDiagnosticOpen, setIsDiagnosticOpen] = useState(false);

  // --- Smart Logic ---
  const categorizeEvent = (event) => {
    const text = `${event.summary || ''} ${event.description || ''}`.toLowerCase();
    const assigned = FAMILY_MEMBERS.filter(member => 
      (NAME_VARIATIONS[member] || [member.toLowerCase()]).some(v => text.includes(v))
    );
    return assigned.length === 0 ? FAMILY_MEMBERS : assigned;
  };

  const fetchEvents = useCallback(async (token) => {
    if (!window.gapi?.client?.calendar) return;
    setLoading(true);
    setError(null);
    try {
      if (token) window.gapi.client.setToken({ access_token: token });
      
      const now = new Date();
      now.setHours(0,0,0,0);
      const timeMin = now.toISOString();
      const timeMax = new Date(now.getTime() + (31 * 24 * 60 * 60 * 1000)).toISOString();

      let fetched = [];
      for (const id of CALENDAR_IDS) {
        const resp = await window.gapi.client.calendar.events.list({
          calendarId: id,
          timeMin, timeMax,
          showDeleted: false,
          singleEvents: true,
          orderBy: 'startTime',
        });
        const items = (resp.result.items || []).map(item => ({
          ...item,
          assignedTo: categorizeEvent(item),
          calendarName: id.includes('family') ? 'Family' : 'Personal',
          start_date: new Date(item.start.dateTime || item.start.date)
        }));
        fetched = [...fetched, ...items];
      }
      setAllEvents(fetched.sort((a, b) => a.start_date - b.start_date));
    } catch (err) {
      console.error(err);
      setError("Failed to fetch events. You may need to sign in again.");
      setUser(null);
    } finally { setLoading(false); }
  }, []);

  // --- Google Initialization & Hash Parsing ---
  useEffect(() => {
    const init = () => {
      // 1. GAPI Client Init
      const gapiScript = document.createElement('script');
      gapiScript.src = "https://apis.google.com/js/api.js";
      gapiScript.onload = () => {
        window.gapi.load('client', async () => {
          await window.gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
          
          // 2. Check URL for token after redirect
          const hash = window.location.hash;
          if (hash.includes('access_token')) {
            const params = new URLSearchParams(hash.substring(1));
            const token = params.get('access_token');
            if (token) {
              setUser({ token });
              fetchEvents(token);
              // Clean up URL without refreshing
              window.history.replaceState({}, document.title, window.location.pathname);
            }
          }
        });
      };
      document.body.appendChild(gapiScript);

      // 3. GIS Identity Init (Redirect Mode)
      const gisScript = document.createElement('script');
      gisScript.src = "https://accounts.google.com/gsi/client";
      gisScript.onload = () => {
        const client = window.google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          ux_mode: 'redirect',
          redirect_uri: window.location.origin + window.location.pathname,
        });
        setTokenClient(client);
      };
      document.body.appendChild(gisScript);
    };
    init();
  }, [fetchEvents]);

  // Weather Logic
  useEffect(() => {
    fetch('https://api.open-meteo.com/v1/forecast?latitude=51.7836&longitude=-1.4883&current=temperature_2m&daily=temperature_2m_max,temperature_2m_min&timezone=Europe/London')
      .then(res => res.json())
      .then(data => setWeather({ temp: Math.round(data.current.temperature_2m), high: Math.round(data.daily.temperature_2m_max[0]), low: Math.round(data.daily.temperature_2m_min[0]) }))
      .catch(() => {});
  }, []);

  const filteredEvents = useMemo(() => {
    const today = new Date();
    today.setHours(0,0,0,0);
    return allEvents.filter(e => {
      if (view === 'today') return e.start_date.toDateString() === today.toDateString();
      if (view === 'week') {
        const nextWeek = new Date(today);
        nextWeek.setDate(today.getDate() + 7);
        return e.start_date >= today && e.start_date < nextWeek;
      }
      return e.start_date.getMonth() === currentDate.getMonth();
    });
  }, [allEvents, view, currentDate]);

  return (
    <div className="flex h-screen bg-slate-100 text-slate-900 overflow-hidden font-sans">
      <aside className="w-64 bg-white border-r border-slate-200 p-6 flex flex-col hidden md:flex">
        <div className="flex items-center gap-2 mb-8">
          <div className="p-2 bg-indigo-600 rounded-lg text-white shadow-lg shadow-indigo-100"><LayoutDashboard size={20} /></div>
          <h1 className="text-xl font-bold">FamilyHub</h1>
        </div>

        <nav className="space-y-1 flex-grow">
          {['Today', 'Week', 'Month'].map(v => (
            <button key={v} onClick={() => setView(v.toLowerCase())} className={`flex items-center gap-3 w-full p-3 rounded-xl transition-all font-medium ${view === v.toLowerCase() ? 'bg-indigo-50 text-indigo-700' : 'text-slate-500 hover:bg-slate-50'}`}>
              <CalendarIcon size={18} /> {v}
            </button>
          ))}
        </nav>

        <div className="mt-auto space-y-4">
          {weather && (
            <div className="p-4 bg-slate-50 rounded-2xl border border-slate-100">
              <div className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Weather</div>
              <div className="text-xl font-bold">{weather.temp}°C</div>
              <div className="text-[10px] text-slate-500">H: {weather.high}° L: {weather.low}°</div>
            </div>
          )}
          <button 
            onClick={() => user ? setUser(null) : tokenClient?.requestAccessToken()} 
            className={`w-full flex items-center justify-center gap-2 p-3 rounded-xl text-sm font-bold transition-all ${user ? 'bg-slate-100 text-slate-600' : 'bg-indigo-600 text-white'}`}
          >
            {user ? <LogOut size={16}/> : <LogIn size={16}/>} {user ? 'Sign Out' : 'Connect Google'}
          </button>
        </div>
      </aside>

      <main className="flex-grow flex flex-col">
        <header className="bg-white border-b border-slate-200 p-6 flex items-center justify-between">
          <h2 className="text-2xl font-bold text-slate-800 capitalize">{view}'s Schedule</h2>
          <div className="flex items-center gap-2">
            {loading && <RefreshCw size={16} className="text-indigo-600 animate-spin mr-2" />}
            <div className="flex -space-x-2">
              {FAMILY_MEMBERS.map((m, i) => (
                <div key={m} title={m} className={`w-8 h-8 rounded-full border-2 border-white flex items-center justify-center text-[10px] font-bold text-white bg-indigo-${400 + (i*100)} shadow-sm`}>{m[0]}</div>
              ))}
            </div>
          </div>
        </header>

        <section className="flex-grow p-8 overflow-y-auto">
          {error && <div className="mb-6 p-4 bg-red-50 border border-red-100 rounded-2xl text-red-700 text-sm">{error}</div>}

          {!user ? (
            <div className="h-full flex flex-col items-center justify-center text-center max-w-sm mx-auto">
              <div className="w-20 h-20 bg-indigo-50 text-indigo-600 rounded-3xl flex items-center justify-center mb-6 shadow-xl shadow-indigo-50"><CalendarIcon size={36}/></div>
              <h3 className="text-xl font-bold text-slate-800 mb-2">Sync Connection Required</h3>
              <p className="text-slate-500 mb-8 text-sm">Sign in to sync your family and personal Google calendars into this dashboard.</p>
              <button onClick={() => tokenClient?.requestAccessToken()} className="bg-indigo-600 text-white px-8 py-3 rounded-2xl font-bold hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-100">Authorize Google Access</button>
            </div>
          ) : (
            <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6">
              {FAMILY_MEMBERS.map((member, idx) => {
                const memberEvents = filteredEvents.filter(e => e.assignedTo.includes(member));
                return (
                  <div key={member} className="flex flex-col gap-4">
                    <h3 className="font-bold text-slate-800 flex items-center justify-between px-1">
                      <span className="flex items-center gap-2"><div className={`w-2 h-2 rounded-full bg-indigo-${400+(idx*100)}`} />{member}</span>
                      <span className="text-[10px] bg-slate-200 text-slate-600 px-1.5 py-0.5 rounded-md">{memberEvents.length}</span>
                    </h3>
                    <div className="space-y-3">
                      {memberEvents.map(e => (
                        <div key={e.id} className="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm hover:border-indigo-200 transition-all">
                          <p className="text-[9px] font-bold text-indigo-500 uppercase tracking-widest mb-1">{e.calendarName}</p>
                          <p className="text-sm font-bold text-slate-800 mb-1">{e.summary}</p>
                          <p className="text-[11px] text-slate-400 font-medium flex items-center gap-1"><Clock size={10}/> {e.start_date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
                        </div>
                      ))}
                      {memberEvents.length === 0 && <div className="h-24 rounded-2xl border-2 border-dashed border-slate-100 flex items-center justify-center opacity-30 text-[9px] font-bold uppercase tracking-tighter">No events</div>}
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </section>
      </main>
    </div>
  );
};

export default App;
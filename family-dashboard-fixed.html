<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FamilyHub Dashboard</title>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for in-browser JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        iframe { filter: none !important; opacity: 1 !important; border-radius: 1.5rem; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;
        
        // --- Configuration ---
        const CLIENT_ID = '123608984638-af4v7ira3qae7ftbbi10dhvd7hbgotsb.apps.googleusercontent.com';
        const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest";
        const SCOPES = "https://www.googleapis.com/auth/calendar.readonly";
        const MAPS_API_KEY = 'AIzaSyAQKZpqJfl4Y9yQtCKGa1dl0ItW_15SrG0'; 
        const HOME_ADDRESS = 'Wood Lane, Southmoor, Oxfordshire';
        const SCHOOL_ADDRESS = 'Pinewood School, Bourton, Wiltshire';

        const FAMILY_MEMBERS = ['Jonathan', 'Alex', 'Rufus', 'Madeline', 'Theo'];
        const MEMBER_CONFIG = {
            'Jonathan': { color: 'bg-blue-50 text-blue-800 border-blue-200', tag: 'bg-blue-600', variations: ['jonathan', 'jon'] },
            'Alex': { color: 'bg-rose-50 text-rose-800 border-rose-200', tag: 'bg-rose-600', variations: ['alex', 'alexandra'] },
            'Rufus': { color: 'bg-orange-50 text-orange-800 border-orange-200', tag: 'bg-orange-600', variations: ['rufus'] },
            'Madeline': { color: 'bg-fuchsia-50 text-fuchsia-800 border-fuchsia-200', tag: 'bg-fuchsia-600', variations: ['madeline', 'maddie', 'maddy'] },
            'Theo': { color: 'bg-indigo-50 text-indigo-800 border-indigo-200', tag: 'bg-indigo-600', variations: ['theo', 'theodore'] },
            'Family': { color: 'bg-emerald-50 text-emerald-800 border-emerald-200', tag: 'bg-emerald-600', variations: [] }
        };

        // --- Native SVG Icons (Eliminates all Lucide errors) ---
        const Icons = {
            Dashboard: () => <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>,
            Weather: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M16 14v6"/><path d="M8 14v6"/><path d="M12 16v6"/></svg>,
            CheckSquare: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="m9 12 2 2 4-4"/></svg>,
            Navigation: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg>,
            Clock: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Trash: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Plus: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>,
            Alert: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
            Login: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></svg>,
            Logout: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
            Calendar: () => <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        };

        const App = () => {
            const [allEvents, setAllEvents] = useState([]);
            const [weather, setWeather] = useState(null);
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(false);
            const [tokenClient, setTokenClient] = useState(null);
            const [currentTime, setCurrentTime] = useState(new Date());
            const [originError, setOriginError] = useState(window.location.protocol === 'file:');
            
            const [tasks, setTasks] = useState(() => {
                try {
                    const saved = localStorage.getItem('family_tasks');
                    return saved ? JSON.parse(saved) : [
                        { id: 1, text: 'Renew school bus passes', completed: false },
                        { id: 2, text: 'Order logs for burner', completed: true }
                    ];
                } catch (e) { return []; }
            });
            const [newTaskText, setNewTaskText] = useState('');

            useEffect(() => {
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                try { localStorage.setItem('family_tasks', JSON.stringify(tasks)); } catch (e) {}
            }, [tasks]);

            const categorizeEvent = (event) => {
                const text = `${event.summary || ''} ${event.description || ''}`.toLowerCase();
                const assigned = FAMILY_MEMBERS.filter(member => 
                    (MEMBER_CONFIG[member].variations).some(v => text.includes(v))
                );
                return assigned.length === 0 ? ['Family'] : assigned;
            };

            const fetchEvents = useCallback(async (token) => {
                if (!window.gapi?.client?.calendar) return;
                setLoading(true);
                try {
                    window.gapi.client.setToken({ access_token: token });
                    const now = new Date();
                    now.setHours(0,0,0,0);
                    const timeMin = now.toISOString();
                    const timeMax = new Date(now.getTime() + (31 * 24 * 60 * 60 * 1000)).toISOString();

                    let fetched = [];
                    const CAL_IDS = ['primary', 'jonathan.bound@gmail.com', 'family07456545553640322749@group.calendar.google.com'];
                    
                    for (const id of CAL_IDS) {
                        try {
                            const resp = await window.gapi.client.calendar.events.list({
                                calendarId: id, timeMin, timeMax, singleEvents: true, orderBy: 'startTime'
                            });
                            const items = (resp.result.items || []).map(item => ({
                                ...item,
                                assignedTo: categorizeEvent(item),
                                calendarName: id.includes('family') ? 'Family' : 'Personal',
                                start_date: new Date(item.start.dateTime || item.start.date)
                            }));
                            fetched = [...fetched, ...items];
                        } catch (e) { console.warn(`Calendar ${id} access restricted`); }
                    }
                    setAllEvents(fetched.sort((a, b) => a.start_date - b.start_date));
                } catch (err) { console.error("Sync fail", err); }
                finally { setLoading(false); }
            }, []);

            useEffect(() => {
                const script = document.createElement('script');
                script.src = "https://apis.google.com/js/api.js";
                script.onload = () => {
                    window.gapi.load('client', async () => {
                        await window.gapi.client.init({ discoveryDocs: [DISCOVERY_DOC] });
                        if (window.location.hash.includes('access_token')) {
                            const t = new URLSearchParams(window.location.hash.substring(1)).get('access_token');
                            setUser({ token: t });
                            fetchEvents(t);
                            window.history.replaceState({}, document.title, window.location.pathname);
                        }
                    });
                };
                document.body.appendChild(script);

                const gis = document.createElement('script');
                gis.src = "https://accounts.google.com/gsi/client";
                gis.onload = () => {
                    const client = window.google.accounts.oauth2.initTokenClient({
                        client_id: CLIENT_ID, scope: SCOPES, ux_mode: 'redirect',
                        redirect_uri: window.location.origin + window.location.pathname,
                    });
                    setTokenClient(client);
                };
                document.body.appendChild(gis);

                fetch('https://api.open-meteo.com/v1/forecast?latitude=51.67&longitude=-1.41&current=temperature_2m,weathercode&daily=precipitation_probability_max&timezone=Europe/London')
                    .then(r => r.json()).then(d => setWeather({ 
                        temp: Math.round(d.current.temperature_2m), 
                        rain: d.daily.precipitation_probability_max[0] 
                    })).catch(err => console.error("Weather unreachable"));
            }, [fetchEvents]); 

            const addTask = () => {
                if (!newTaskText.trim()) return;
                setTasks([...tasks, { id: Date.now(), text: newTaskText, completed: false }]);
                setNewTaskText('');
            };

            const toggleTask = (id) => {
                setTasks(tasks.map(t => t.id === id ? { ...t, completed: !t.completed } : t));
            };

            const removeTask = (id) => {
                setTasks(tasks.filter(t => t.id !== id));
            };

            const scheduleColumns = useMemo(() => {
                const today = new Date(); today.setHours(0,0,0,0);
                const nextWeek = new Date(today); nextWeek.setDate(today.getDate() + 7);
                return {
                    'Today': allEvents.filter(e => e.start_date.toDateString() === today.toDateString()),
                    'This Week': allEvents.filter(e => e.start_date >= today && e.start_date < nextWeek),
                    'This Month': allEvents.filter(e => e.start_date.getMonth() === today.getMonth())
                };
            }, [allEvents]);

            const greeting = useMemo(() => {
                const hour = currentTime.getHours();
                if (hour < 12) return "Good Morning";
                if (hour < 18) return "Good Afternoon";
                return "Good Evening";
            }, [currentTime]);

            return (
                <div className="flex h-screen bg-slate-50 text-slate-900 overflow-hidden font-sans text-left relative">
                    {/* Origin Security Alert */}
                    {originError && (
                        <div className="absolute top-4 left-1/2 -translate-x-1/2 z-[100] bg-white border border-rose-100 p-6 rounded-[2rem] shadow-2xl max-w-xl">
                            <div className="flex gap-4">
                                <div className="bg-rose-50 p-3 rounded-2xl text-rose-500 flex-shrink-0">
                                    <Icons.Alert />
                                </div>
                                <div className="text-left">
                                    <p className="text-sm font-black text-slate-800">Browser Security Restriction</p>
                                    <p className="text-xs text-slate-500 mt-1 leading-relaxed">
                                        Google Calendar sync requires a web server to function. 
                                        Please use a local server (e.g. VS Code Live Server) instead of opening the file directly.
                                    </p>
                                    <button onClick={() => setOriginError(false)} className="mt-3 text-[10px] uppercase font-black tracking-widest text-rose-600 hover:underline">Dismiss</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <aside className="w-80 bg-white border-r border-slate-200 p-6 flex flex-col items-start hidden lg:flex shadow-sm z-20 overflow-y-auto hide-scroll">
                        <div className="flex items-center gap-4 mb-10 w-full">
                            <div className="p-3 bg-indigo-600 rounded-2xl text-white shadow-xl shadow-indigo-100 flex-shrink-0">
                                <Icons.Dashboard />
                            </div>
                            <div className="text-left">
                                <h1 className="text-2xl font-black tracking-tight text-slate-800">FamilyHub</h1>
                                <p className="text-[10px] font-black text-slate-400 uppercase tracking-[0.3em] leading-none">Control</p>
                            </div>
                        </div>

                        <div className="space-y-6 w-full">
                            {weather && (
                                <div className="p-5 bg-slate-50 rounded-[2rem] border border-slate-100 flex items-center justify-between shadow-sm w-full">
                                    <div className="text-left">
                                        <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Weather</span>
                                        <div className="text-3xl font-black text-slate-800 mt-1 tracking-tighter">{weather.temp}°C</div>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-blue-500 flex items-center gap-1.5 justify-end font-bold text-sm">
                                            <Icons.Weather />
                                            <span>{weather.rain}%</span>
                                        </div>
                                        <span className="text-[10px] text-slate-400 font-bold uppercase tracking-tighter">Precipitation</span>
                                    </div>
                                </div>
                            )}

                            <div className="p-6 bg-white rounded-[2rem] border border-slate-100 shadow-sm w-full text-left">
                                <div className="flex items-center justify-between mb-5">
                                    <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Shared To-Do</span>
                                    <div className="text-emerald-500"><Icons.CheckSquare /></div>
                                </div>
                                <div className="space-y-3 mb-6 max-h-64 overflow-y-auto hide-scroll">
                                    {tasks.map(task => (
                                        <div key={task.id} className="flex items-center gap-4 group">
                                            <button 
                                                onClick={() => toggleTask(task.id)}
                                                className={`w-5 h-5 rounded-lg border-2 flex items-center justify-center transition-all flex-shrink-0 ${task.completed ? 'bg-emerald-500 border-emerald-500' : 'border-slate-200 hover:border-emerald-400'}`}
                                            >
                                                {task.completed && <div className="w-1.5 h-1.5 bg-white rounded-full" />}
                                            </button>
                                            <span className={`text-sm font-semibold flex-grow truncate text-left ${task.completed ? 'text-slate-400 line-through' : 'text-slate-700'}`}>
                                                {task.text}
                                            </span>
                                            <button onClick={() => removeTask(task.id)} className="opacity-0 group-hover:opacity-100 text-slate-300 hover:text-rose-500 transition-all flex-shrink-0">
                                                <Icons.Trash />
                                            </button>
                                        </div>
                                    ))}
                                </div>
                                <div className="relative">
                                    <input 
                                        type="text" 
                                        value={newTaskText}
                                        onChange={(e) => setNewTaskText(e.target.value)}
                                        onKeyDown={(e) => e.key === 'Enter' && addTask()}
                                        placeholder="Add task..."
                                        className="w-full bg-slate-50 border border-slate-100 rounded-2xl px-5 py-3 text-xs font-semibold focus:outline-none focus:ring-2 focus:ring-indigo-100 transition-all"
                                    />
                                    <button onClick={addTask} className="absolute right-3 top-2.5 text-indigo-500 hover:text-indigo-700">
                                        <Icons.Plus />
                                    </button>
                                </div>
                            </div>

                            <div className="p-5 bg-white rounded-[2rem] border border-slate-100 shadow-sm overflow-hidden w-full text-left">
                                <div className="flex items-center justify-between mb-4 w-full">
                                    <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest text-left">School Run</span>
                                    <div className="text-indigo-500"><Icons.Navigation /></div>
                                </div>
                                <div className="h-[500px] rounded-2xl bg-slate-100 overflow-hidden shadow-inner ring-1 ring-slate-100">
                                    <iframe 
                                        src={`https://www.google.com/maps/embed/v1/directions?key=${MAPS_API_KEY}&origin=${encodeURIComponent(HOME_ADDRESS)}&destination=${encodeURIComponent(SCHOOL_ADDRESS)}&mode=driving`} 
                                        allowFullScreen 
                                    />
                                </div>
                            </div>
                        </div>

                        <button 
                            onClick={() => user ? setUser(null) : tokenClient?.requestAccessToken()} 
                            className="mt-10 w-full flex items-center justify-center gap-3 p-5 rounded-3xl text-sm font-bold bg-slate-50 border border-slate-100 text-slate-500 hover:bg-slate-100 transition-all"
                        >
                            {user ? <Icons.Logout /> : <Icons.Login />} 
                            {user ? 'Sign Out' : 'Sync Calendar'}
                        </button>
                    </aside>

                    {/* Main Workspace */}
                    <main className="flex-grow flex flex-col overflow-hidden bg-slate-50">
                        <header className="bg-white border-b border-slate-200 px-10 py-8 flex items-center justify-between shadow-sm z-10 text-left">
                            <div>
                                <h2 className="text-4xl font-black text-slate-800 tracking-tight">{greeting}, Bounds</h2>
                                <p className="text-[10px] font-black text-slate-400 uppercase tracking-[0.4em] mt-2 flex items-center gap-3">
                                    <span className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse" />
                                    Hub Dashboard • {currentTime.toLocaleDateString(undefined, { weekday: 'long', day: 'numeric', month: 'long' })}
                                </p>
                            </div>
                            <div className="flex items-center gap-10">
                                <div className="text-right hidden md:block">
                                    <div className="text-3xl font-black text-slate-800 tracking-tighter leading-none">
                                        {currentTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                    </div>
                                    <div className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Local Time</div>
                                </div>
                                <div className="flex -space-x-3">
                                    {FAMILY_MEMBERS.map((m, i) => (
                                        <div key={m} title={m} className={`w-12 h-12 rounded-full border-[4px] border-white flex items-center justify-center text-[12px] font-black text-white shadow-xl ring-1 ring-slate-100 bg-indigo-${400 + (i*100)}`}>
                                            {m[0]}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </header>

                        <section className="flex-grow p-10 overflow-hidden flex flex-col gap-8">
                            {!user ? (
                                <div className="h-full flex flex-col items-center justify-center text-center max-w-md mx-auto">
                                    <div className="w-28 h-28 bg-indigo-50 text-indigo-600 rounded-[3rem] flex items-center justify-center mb-8 shadow-inner ring-1 ring-indigo-100 animate-pulse mx-auto">
                                        <Icons.Calendar />
                                    </div>
                                    <h3 className="text-3xl font-black text-slate-800 mb-3 tracking-tight">Sync Required</h3>
                                    <p className="text-slate-500 mb-10 text-base font-medium leading-relaxed">Connect your Google account to view family schedules and school runs.</p>
                                    <button onClick={() => tokenClient?.requestAccessToken()} className="bg-indigo-600 text-white px-12 py-5 rounded-[2rem] font-bold text-lg hover:bg-indigo-700 shadow-2xl transition-all active:scale-95">Authorize Sync</button>
                                </div>
                            ) : (
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-10 h-full overflow-hidden">
                                    {Object.entries(scheduleColumns).map(([key, events]) => (
                                        <div key={key} className="flex flex-col h-full bg-white rounded-[2.5rem] border border-slate-200/60 overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                                            <div className="p-8 border-b border-slate-100 bg-slate-50/30 flex items-center justify-between">
                                                <h3 className="font-black text-slate-800 uppercase tracking-widest text-[13px]">{key}</h3>
                                                <span className="text-[12px] font-black bg-indigo-600 text-white px-4 py-1.5 rounded-full shadow-lg shadow-indigo-100">{events.length}</span>
                                            </div>
                                            <div className="flex-grow overflow-y-auto p-6 space-y-5 hide-scroll text-left">
                                                {events.map(e => {
                                                    const person = e.assignedTo[0] || 'Family';
                                                    const config = MEMBER_CONFIG[person] || MEMBER_CONFIG['Family'];
                                                    return (
                                                        <div key={e.id} className={`p-6 rounded-[2rem] border-l-[10px] shadow-sm transition-all hover:translate-x-1 ${config.color}`}>
                                                            <div className="flex items-center justify-between mb-4">
                                                                <div className="flex items-center gap-2 font-bold text-[11px] opacity-70 uppercase tracking-widest">
                                                                    <Icons.Clock /> {e.start_date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                                                </div>
                                                                <span className="text-[9px] font-black uppercase opacity-40">{e.calendarName}</span>
                                                            </div>
                                                            <p className="text-base font-bold leading-snug mb-5 text-slate-800">{e.summary}</p>
                                                            <div className="flex flex-wrap gap-2">
                                                                {e.assignedTo.map(p => (
                                                                    <span key={p} className={`px-3 py-1 rounded-full text-[10px] font-black text-white uppercase shadow-sm ${MEMBER_CONFIG[p]?.tag || 'bg-slate-400'}`}>{p}</span>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                                {events.length === 0 && <div className="py-24 text-center text-slate-300 uppercase text-[12px] font-black tracking-[0.5em] opacity-40 flex flex-col items-center gap-5">
                                                    <div className="rotate-12"><Icons.Calendar /></div>
                                                    No Events
                                                </div>}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </section>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
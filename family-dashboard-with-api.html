<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .current-time {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .auth-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        .auth-section h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .auth-section p {
            margin-bottom: 20px;
            color: #666;
        }

        .top-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            margin-bottom: 15px;
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .weather-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .weather-temp {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
        }

        .weather-details {
            flex: 1;
        }

        .weather-details p {
            margin: 5px 0;
            font-size: 1.1em;
        }

        .traffic-info {
            font-size: 1.1em;
        }

        .traffic-route {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .traffic-time {
            font-size: 1.5em;
            font-weight: bold;
            color: #28a745;
            margin: 10px 0;
        }

        .traffic-time.moderate {
            color: #ffc107;
        }

        .traffic-time.heavy {
            color: #dc3545;
        }

        .calendar-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-primary.active {
            background: #764ba2;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .calendar-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .person-calendar {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .person-header {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid;
        }

        .person-1 .person-header { border-color: #667eea; color: #667eea; }
        .person-2 .person-header { border-color: #28a745; color: #28a745; }
        .person-3 .person-header { border-color: #ffc107; color: #ffc107; }
        .person-4 .person-header { border-color: #dc3545; color: #dc3545; }
        .person-5 .person-header { border-color: #17a2b8; color: #17a2b8; }

        .event {
            background: #f8f9fa;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .person-1 .event { border-color: #667eea; }
        .person-2 .event { border-color: #28a745; }
        .person-3 .event { border-color: #ffc107; }
        .person-4 .event { border-color: #dc3545; }
        .person-5 .event { border-color: #17a2b8; }

        .event-time {
            font-weight: bold;
            color: #666;
            font-size: 0.9em;
        }

        .event-title {
            margin-top: 5px;
            font-size: 1.1em;
        }

        .event-source {
            margin-top: 5px;
            font-size: 0.8em;
            color: #999;
            font-style: italic;
        }

        .no-events {
            color: #999;
            font-style: italic;
            padding: 20px;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            margin-left: 10px;
        }

        .status-connected {
            background: #d4edda;
            color: #155724;
        }

        .status-disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .top-section {
                grid-template-columns: 1fr;
            }
            
            .calendar-section {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>üè† Family Dashboard</h1>
            <div class="current-time" id="currentTime"></div>
        </div>

        <div class="auth-section" id="authSection">
            <h2>üìÖ Connect Your Google Calendars</h2>
            <p>Click the button below to sign in with Google and authorize access to your calendars.</p>
            <button class="btn btn-success" onclick="handleAuthClick()">Sign In with Google</button>
        </div>

        <div id="mainContent" style="display: none;">
            <div class="top-section">
                <div class="card">
                    <h2>üå§Ô∏è Weather - West Oxfordshire</h2>
                    <div id="weatherInfo" class="loading">Loading weather...</div>
                </div>

                <div class="card">
                    <h2>üöó School Run Traffic</h2>
                    <div id="trafficInfo" class="loading">Loading traffic...</div>
                </div>
            </div>

            <div class="card">
                <h2>üìÖ Family Calendar
                    <span class="status-badge status-connected" id="calendarStatus">Connected</span>
                </h2>
                <div class="calendar-controls">
                    <button class="btn btn-primary active" onclick="changeView('today')">Today</button>
                    <button class="btn btn-primary" onclick="changeView('week')">This Week</button>
                    <button class="btn btn-primary" onclick="changeView('month')">This Month</button>
                    <button class="btn btn-primary" onclick="refreshCalendar()">üîÑ Refresh</button>
                    <button class="btn btn-danger" onclick="handleSignoutClick()" style="margin-left: auto;">Sign Out</button>
                </div>
                <div class="calendar-section" id="calendarSection">
                    <div class="loading">Loading calendars...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CLIENT_ID = '123608984638-af4v7ira3qae7ftbbi10dhvd7hbgotsb.apps.googleusercontent.com';
        const API_KEY = 'YOUR_API_KEY_HERE'; // We'll add this if needed for public calendar access
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly';

        // Your calendar IDs
        const CALENDAR_IDS = [
            'jonathan.bound@gmail.com',
            'family07456545553640322749@group.calendar.google.com'
        ];

        // Family member names for smart categorization
        const FAMILY_MEMBERS = ['Jonathan', 'Sarah', 'Emma', 'Jack', 'Olivia'];

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let accessToken = null;
        let currentView = 'today';
        let allEvents = [];

        // Initialize Google API
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        // Initialize Google Identity Services
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // defined later
                ux_mode: 'popup',
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                // Check if we have a stored token
                const storedToken = localStorage.getItem('google_access_token');
                if (storedToken) {
                    accessToken = storedToken;
                    gapi.client.setToken({ access_token: accessToken });
                    showMainContent();
                    loadAllData();
                }
            }
        }

        // Handle authorization
        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                accessToken = gapi.client.getToken().access_token;
                localStorage.setItem('google_access_token', accessToken);
                showMainContent();
                loadAllData();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        // Handle sign out
        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                localStorage.removeItem('google_access_token');
                accessToken = null;
            }
            showAuthSection();
        }

        function showMainContent() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        function showAuthSection() {
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
        }

        // Fetch calendar events
        async function fetchCalendarEvents() {
            const now = new Date();
            const timeMin = now.toISOString();
            const timeMax = new Date(now.getTime() + (60 * 24 * 60 * 60 * 1000)).toISOString(); // 60 days from now
            
            allEvents = [];
            
            for (const calendarId of CALENDAR_IDS) {
                try {
                    const response = await gapi.client.calendar.events.list({
                        'calendarId': calendarId,
                        'timeMin': timeMin,
                        'timeMax': timeMax,
                        'showDeleted': false,
                        'singleEvents': true,
                        'orderBy': 'startTime'
                    });
                    
                    const events = response.result.items;
                    if (events && events.length > 0) {
                        events.forEach(event => {
                            allEvents.push({
                                ...event,
                                calendarId: calendarId
                            });
                        });
                    }
                } catch (err) {
                    console.error('Error fetching calendar:', calendarId, err);
                }
            }
            
            displayCalendar(currentView);
        }

        // Smart categorization: assign events to family members
        function categorizeEvent(event) {
            const title = event.summary || '';
            const description = event.description || '';
            const text = (title + ' ' + description).toLowerCase();
            
            const assignedMembers = [];
            
            // Check if any family member names appear in the event
            FAMILY_MEMBERS.forEach(member => {
                if (text.includes(member.toLowerCase())) {
                    assignedMembers.push(member);
                }
            });
            
            // If no specific members found, assign to everyone
            if (assignedMembers.length === 0) {
                return FAMILY_MEMBERS;
            }
            
            return assignedMembers;
        }

        // Filter events based on view
        function filterEvents(events, view) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            return events.filter(event => {
                const startTime = event.start.dateTime || event.start.date;
                const eventDate = new Date(startTime);
                
                if (view === 'today') {
                    return eventDate.toDateString() === today.toDateString();
                } else if (view === 'week') {
                    const weekFromNow = new Date(today);
                    weekFromNow.setDate(weekFromNow.getDate() + 7);
                    return eventDate >= today && eventDate < weekFromNow;
                } else if (view === 'month') {
                    const monthFromNow = new Date(today);
                    monthFromNow.setMonth(monthFromNow.getMonth() + 1);
                    return eventDate >= today && eventDate < monthFromNow;
                }
            });
        }

        // Display calendar events
        function displayCalendar(view) {
            const calendarSection = document.getElementById('calendarSection');
            const filteredEvents = filterEvents(allEvents, view);
            
            // Create events map for each person
            const personEvents = {};
            FAMILY_MEMBERS.forEach(member => {
                personEvents[member] = [];
            });
            
            // Categorize and assign events
            filteredEvents.forEach(event => {
                const assignedTo = categorizeEvent(event);
                assignedTo.forEach(member => {
                    personEvents[member].push(event);
                });
            });
            
            // Build HTML
            let html = '';
            
            FAMILY_MEMBERS.forEach((person, index) => {
                const events = personEvents[person];
                
                html += `
                    <div class="person-calendar person-${index + 1}">
                        <div class="person-header">${person}</div>
                `;
                
                if (events.length === 0) {
                    html += `<div class="no-events">No events ${view === 'today' ? 'today' : 'in this period'}</div>`;
                } else {
                    events.sort((a, b) => {
                        const aTime = new Date(a.start.dateTime || a.start.date);
                        const bTime = new Date(b.start.dateTime || b.start.date);
                        return aTime - bTime;
                    });
                    
                    events.forEach(event => {
                        const startTime = event.start.dateTime || event.start.date;
                        const eventDate = new Date(startTime);
                        
                        let timeStr = '';
                        let dateStr = '';
                        
                        if (event.start.dateTime) {
                            // Timed event
                            timeStr = eventDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                            dateStr = eventDate.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });
                        } else {
                            // All-day event
                            timeStr = 'All day';
                            dateStr = eventDate.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });
                        }
                        
                        const displayTime = view === 'today' ? timeStr : dateStr + ' ' + timeStr;
                        const calendarName = event.calendarId.includes('family') ? 'Family Calendar' : 'Personal';
                        
                        html += `
                            <div class="event">
                                <div class="event-time">${displayTime}</div>
                                <div class="event-title">${event.summary || 'Untitled Event'}</div>
                                <div class="event-source">${calendarName}</div>
                            </div>
                        `;
                    });
                }
                
                html += `</div>`;
            });
            
            calendarSection.innerHTML = html;
        }

        // Change calendar view
        function changeView(view) {
            currentView = view;
            
            // Update button states
            document.querySelectorAll('.calendar-controls .btn-primary').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            displayCalendar(view);
        }

        // Refresh calendar
        function refreshCalendar() {
            document.getElementById('calendarSection').innerHTML = '<div class="loading">Refreshing calendars...</div>';
            fetchCalendarEvents();
        }

        // Update current time
        function updateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            document.getElementById('currentTime').textContent = now.toLocaleDateString('en-GB', options);
        }

        // Fetch weather data
        async function fetchWeather() {
            try {
                const response = await fetch('https://api.open-meteo.com/v1/forecast?latitude=51.7836&longitude=-1.4883&current=temperature_2m,weathercode,windspeed_10m&daily=temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=Europe/London');
                const data = await response.json();
                
                const temp = Math.round(data.current.temperature_2m);
                const weatherCode = data.current.weathercode;
                const windSpeed = Math.round(data.current.windspeed_10m);
                const maxTemp = Math.round(data.daily.temperature_2m_max[0]);
                const minTemp = Math.round(data.daily.temperature_2m_min[0]);
                const precipitation = data.daily.precipitation_sum[0];
                
                const weatherDescriptions = {
                    0: 'Clear sky', 1: 'Mainly clear', 2: 'Partly cloudy', 3: 'Overcast',
                    45: 'Foggy', 48: 'Foggy', 51: 'Light drizzle', 53: 'Drizzle', 55: 'Heavy drizzle',
                    61: 'Light rain', 63: 'Rain', 65: 'Heavy rain', 71: 'Light snow', 73: 'Snow', 75: 'Heavy snow'
                };
                
                const weatherDesc = weatherDescriptions[weatherCode] || 'Unknown';
                
                document.getElementById('weatherInfo').innerHTML = `
                    <div class="weather-info">
                        <div class="weather-temp">${temp}¬∞C</div>
                        <div class="weather-details">
                            <p><strong>${weatherDesc}</strong></p>
                            <p>High: ${maxTemp}¬∞C / Low: ${minTemp}¬∞C</p>
                            <p>Wind: ${windSpeed} km/h</p>
                            <p>Precipitation: ${precipitation} mm</p>
                        </div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('weatherInfo').innerHTML = '<p>Unable to load weather data</p>';
            }
        }

        // Load traffic data (mock for now)
        function loadTraffic() {
            const currentHour = new Date().getHours();
            let duration = 15;
            let status = '';
            
            if (currentHour >= 7 && currentHour <= 9) {
                duration = 25;
                status = 'moderate';
            } else if (currentHour >= 16 && currentHour <= 18) {
                duration = 28;
                status = 'heavy';
            }
            
            document.getElementById('trafficInfo').innerHTML = `
                <div class="traffic-route">
                    <p><strong>Home ‚Üí School</strong></p>
                    <p>Distance: ~8 km</p>
                </div>
                <div class="traffic-time ${status}">
                    ${duration} minutes
                </div>
                <p>${status === 'heavy' ? 'üî¥ Heavy traffic' : status === 'moderate' ? 'üü° Moderate traffic' : 'üü¢ Clear roads'}</p>
                <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                    <em>Note: This is mock data. Real traffic requires Google Maps API setup.</em>
                </p>
            `;
        }

        // Load all data
        function loadAllData() {
            updateTime();
            fetchWeather();
            loadTraffic();
            fetchCalendarEvents();
            
            // Set up auto-refresh intervals
            setInterval(updateTime, 60000); // Every minute
            setInterval(fetchWeather, 600000); // Every 10 minutes
            setInterval(loadTraffic, 300000); // Every 5 minutes
            setInterval(fetchCalendarEvents, 300000); // Every 5 minutes
        }

        // Initialize
        window.onload = function() {
            updateTime();
        };
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
